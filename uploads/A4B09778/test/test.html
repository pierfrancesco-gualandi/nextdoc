<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test per Modelli 3D WebGL</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .file-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .file-item:hover {
            background-color: #f5f5f5;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-preview {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test per Modelli 3D WebGL</h1>
        <p>Questa pagina esegue test diagnostici per verificare il corretto funzionamento dei modelli 3D WebGL.</p>
        
        <div id="info-section">
            <h2>Informazioni di Base</h2>
            <table>
                <tr>
                    <th>User Agent</th>
                    <td id="user-agent"></td>
                </tr>
                <tr>
                    <th>WebGL Supportato</th>
                    <td id="webgl-support"></td>
                </tr>
                <tr>
                    <th>Modalità iFrame</th>
                    <td id="iframe-mode"></td>
                </tr>
                <tr>
                    <th>Origine</th>
                    <td id="origin"></td>
                </tr>
            </table>
        </div>
        
        <div id="folder-info">
            <h2>Informazioni sulla Cartella</h2>
            <div id="folder-info-content">
                <p>In attesa di informazioni dalla pagina principale...</p>
            </div>
            <button id="request-info-btn">Richiedi Informazioni</button>
        </div>
        
        <div id="file-list-section" style="display:none;">
            <h2>Elenco dei File</h2>
            <div class="file-list" id="file-list"></div>
        </div>
        
        <div id="tests-section">
            <h2>Risultati dei Test</h2>
            <div id="test-results"></div>
        </div>
        
        <div id="file-preview-section" style="display:none;">
            <h2>Anteprima File</h2>
            <div class="file-preview" id="file-preview"></div>
        </div>
    </div>

    <script>
        // Variabili globali
        let folderInfo = null;
        
        // Funzione di inizializzazione
        function init() {
            // Popoliamo le informazioni di base
            document.getElementById('user-agent').textContent = navigator.userAgent;
            
            // Controlliamo se WebGL è supportato
            const webglSupport = document.getElementById('webgl-support');
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (gl) {
                    webglSupport.textContent = 'Sì';
                    webglSupport.style.color = 'green';
                } else {
                    webglSupport.textContent = 'No - WebGL non supportato';
                    webglSupport.style.color = 'red';
                }
            } catch (e) {
                webglSupport.textContent = 'Errore nel test: ' + e.message;
                webglSupport.style.color = 'red';
            }
            
            // Controlliamo se siamo in un iframe
            document.getElementById('iframe-mode').textContent = 
                (window.self !== window.top) ? 'Sì (in iframe)' : 'No (finestra principale)';
                
            // Mostriamo l'origine corrente
            document.getElementById('origin').textContent = window.location.origin;
            
            // Configuriamo i listener per i messaggi
            setupMessageListeners();
            
            // Configuriamo il pulsante per richiedere le informazioni
            document.getElementById('request-info-btn').addEventListener('click', requestFolderInfo);
            
            // Richiediamo subito le informazioni
            requestFolderInfo();
        }
        
        // Configura i listener per i messaggi
        function setupMessageListeners() {
            window.addEventListener('message', function(event) {
                const testResults = document.getElementById('test-results');
                testResults.innerHTML += `<div class="test-result loading">Ricevuto messaggio da: ${event.origin}</div>`;
                
                if (event.data && event.data.type === 'model-folder-info') {
                    folderInfo = event.data;
                    
                    // Aggiorna la sezione delle informazioni sulla cartella
                    updateFolderInfo(folderInfo);
                    
                    // Mostra l'elenco dei file se disponibile
                    if (folderInfo.allFiles && folderInfo.allFiles.length > 0) {
                        showFileList(folderInfo.allFiles);
                    } else if (folderInfo.fileMap && Object.keys(folderInfo.fileMap).length > 0) {
                        showFileMap(folderInfo.fileMap);
                    }
                    
                    // Aggiungiamo un risultato di test positivo
                    testResults.innerHTML += `<div class="test-result success">
                        Informazioni sulla cartella ricevute correttamente!
                    </div>`;
                }
            });
        }
        
        // Richiede informazioni sulla cartella
        function requestFolderInfo() {
            const testResults = document.getElementById('test-results');
            testResults.innerHTML += `<div class="test-result loading">
                Invio richiesta informazioni cartella al parent frame...
            </div>`;
            
            try {
                // Invia un messaggio al parent frame
                window.parent.postMessage({ type: 'request-model-folder-info' }, '*');
                
                testResults.innerHTML += `<div class="test-result success">
                    Richiesta inviata correttamente!
                </div>`;
            } catch (e) {
                testResults.innerHTML += `<div class="test-result error">
                    Errore nell'invio della richiesta: ${e.message}
                </div>`;
            }
        }
        
        // Aggiorna le informazioni sulla cartella
        function updateFolderInfo(info) {
            const infoContent = document.getElementById('folder-info-content');
            
            let infoHTML = '<table>';
            infoHTML += `<tr><th>Nome Cartella</th><td>${info.folderName || 'Non specificato'}</td></tr>`;
            infoHTML += `<tr><th>Percorso Cartella</th><td>${info.folderPath || 'Non specificato'}</td></tr>`;
            infoHTML += `<tr><th>Numero File</th><td>${info.allFiles?.length || 'Non specificato'}</td></tr>`;
            infoHTML += `<tr><th>Struttura File</th><td>${Object.keys(info.fileStructure || {}).length} elementi</td></tr>`;
            infoHTML += `<tr><th>File Map</th><td>${Object.keys(info.fileMap || {}).length} elementi</td></tr>`;
            infoHTML += '</table>';
            
            // Aggiungiamo un dump JSON completo
            infoHTML += '<h3>Dump JSON</h3>';
            infoHTML += `<pre>${JSON.stringify(info, null, 2)}</pre>`;
            
            infoContent.innerHTML = infoHTML;
        }
        
        // Mostra l'elenco dei file
        function showFileList(files) {
            const fileListSection = document.getElementById('file-list-section');
            const fileList = document.getElementById('file-list');
            
            fileListSection.style.display = 'block';
            fileList.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <strong>${file.originalName}</strong>
                    ${file.relativePath ? `<br><small>Path: ${file.relativePath}</small>` : ''}
                    <br><small>MIME: ${file.mimeType}</small>
                `;
                
                const actionBtn = document.createElement('button');
                actionBtn.textContent = 'Test';
                actionBtn.onclick = () => testFileAccess(file);
                
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(actionBtn);
                fileList.appendChild(fileItem);
            });
        }
        
        // Mostra la mappa dei file
        function showFileMap(fileMap) {
            const fileListSection = document.getElementById('file-list-section');
            const fileList = document.getElementById('file-list');
            
            fileListSection.style.display = 'block';
            fileList.innerHTML = '';
            
            for (const [path, url] of Object.entries(fileMap)) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <strong>${path}</strong>
                    <br><small>URL: ${url}</small>
                `;
                
                const actionBtn = document.createElement('button');
                actionBtn.textContent = 'Test';
                actionBtn.onclick = () => testFileMapAccess(path, url);
                
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(actionBtn);
                fileList.appendChild(fileItem);
            }
        }
        
        // Testa l'accesso a un file dalla mappa
        function testFileMapAccess(path, url) {
            const testResults = document.getElementById('test-results');
            const filePreviewSection = document.getElementById('file-preview-section');
            const filePreview = document.getElementById('file-preview');
            
            testResults.innerHTML += `<div class="test-result loading">
                Test accesso al file: ${path}
            </div>`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.text();
                })
                .then(content => {
                    testResults.innerHTML += `<div class="test-result success">
                        File accessibile correttamente!
                    </div>`;
                    
                    // Mostra anteprima del file
                    filePreviewSection.style.display = 'block';
                    
                    const fileExtension = path.split('.').pop().toLowerCase();
                    
                    if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(fileExtension)) {
                        filePreview.innerHTML = `<img src="${url}" style="max-width:100%">`;
                    } else if (['html', 'htm'].includes(fileExtension)) {
                        filePreview.innerHTML = `
                            <p>HTML file: <a href="${url}" target="_blank">Apri in una nuova scheda</a></p>
                            <pre>${content.substring(0, 500)}${content.length > 500 ? '...' : ''}</pre>
                        `;
                    } else if (['css', 'js', 'txt', 'json'].includes(fileExtension)) {
                        filePreview.innerHTML = `<pre>${content.substring(0, 1000)}${content.length > 1000 ? '...' : ''}</pre>`;
                    } else {
                        filePreview.innerHTML = `
                            <p>File tipo: ${fileExtension}</p>
                            <p><a href="${url}" target="_blank">Scarica/Apri il file</a></p>
                        `;
                    }
                })
                .catch(error => {
                    testResults.innerHTML += `<div class="test-result error">
                        Errore nell'accesso al file: ${error.message}
                    </div>`;
                    
                    filePreviewSection.style.display = 'block';
                    filePreview.innerHTML = `
                        <p>Errore nell'accesso al file:</p>
                        <pre>${error.toString()}</pre>
                        <p>URL tentato: ${url}</p>
                    `;
                });
        }
        
        // Testa l'accesso a un file
        function testFileAccess(file) {
            const testResults = document.getElementById('test-results');
            const filePreviewSection = document.getElementById('file-preview-section');
            const filePreview = document.getElementById('file-preview');
            
            testResults.innerHTML += `<div class="test-result loading">
                Test accesso al file: ${file.originalName}
            </div>`;
            
            fetch(file.url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.text();
                })
                .then(content => {
                    testResults.innerHTML += `<div class="test-result success">
                        File accessibile correttamente!
                    </div>`;
                    
                    // Mostra anteprima del file
                    filePreviewSection.style.display = 'block';
                    
                    if (file.mimeType.startsWith('image/')) {
                        filePreview.innerHTML = `<img src="${file.url}" style="max-width:100%">`;
                    } else if (file.mimeType.includes('html')) {
                        filePreview.innerHTML = `
                            <p>HTML file: <a href="${file.url}" target="_blank">Apri in una nuova scheda</a></p>
                            <pre>${content.substring(0, 500)}${content.length > 500 ? '...' : ''}</pre>
                        `;
                    } else if (['text/css', 'text/javascript', 'text/plain'].includes(file.mimeType) || 
                              file.mimeType.includes('json')) {
                        filePreview.innerHTML = `<pre>${content.substring(0, 1000)}${content.length > 1000 ? '...' : ''}</pre>`;
                    } else {
                        filePreview.innerHTML = `
                            <p>File tipo: ${file.mimeType}</p>
                            <p><a href="${file.url}" target="_blank">Scarica/Apri il file</a></p>
                        `;
                    }
                })
                .catch(error => {
                    testResults.innerHTML += `<div class="test-result error">
                        Errore nell'accesso al file: ${error.message}
                    </div>`;
                    
                    filePreviewSection.style.display = 'block';
                    filePreview.innerHTML = `
                        <p>Errore nell'accesso al file:</p>
                        <pre>${error.toString()}</pre>
                        <p>URL tentato: ${file.url}</p>
                    `;
                });
        }
        
        // Inizializza quando il documento è pronto
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>